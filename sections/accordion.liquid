{%- liquid
  assign section_id = section.settings.custom_id | default: section.id
  assign allow_multiple = section.settings.allow_multiple
-%}

{%- if section.blocks.size > 0 -%}
  <section
    id="{{ section_id }}"
    class="section-accordion"
    data-allow-multiple="{{ allow_multiple }}"
    style="
      background-color: {{ section.settings.background_color | default: '#ffffff' }};
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
      --accordion-heading-color: {{ section.settings.heading_color | default: '#1a1a1a' }};
      --accordion-text-color: {{ section.settings.text_color | default: '#1a1a1a' }};
      --accordion-border-color: {{ section.settings.border_color | default: '#e5e7eb' }};
    "
  >
    <div class="section-accordion__container">
      {%- if section.settings.heading != blank -%}
        <h2 class="section-accordion__heading">
          {{ section.settings.heading }}
        </h2>
      {%- endif -%}

      <div class="section-accordion__list">
        {%- for block in section.blocks -%}
          <div class="section-accordion__item" {{ block.shopify_attributes }}>
            <button
              class="section-accordion__trigger"
              aria-expanded="false"
              aria-controls="accordion-content-{{ block.id }}"
              type="button"
            >
              <span class="section-accordion__title">
                {{ block.settings.title }}
              </span>
              <span class="section-accordion__icon">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 9l6 6 6-6"/>
                </svg>
              </span>
            </button>
            <div
              id="accordion-content-{{ block.id }}"
              class="section-accordion__content"
              hidden
            >
              <div class="section-accordion__inner">
                {{ block.settings.content }}
              </div>
            </div>
          </div>
        {%- endfor -%}
      </div>
    </div>
  </section>

  <style>
    .section-accordion {
      padding-top: var(--section-padding-top, 3rem);
      padding-bottom: var(--section-padding-bottom, 3rem);
    }

    .section-accordion__container {
      max-width: 1280px;
      margin: 0 auto;
      padding: 0 1.5rem;
    }

    .section-accordion__heading {
      font-size: 1.875rem;
      margin-bottom: 2rem;
      text-transform: uppercase;
      letter-spacing: 0.025em;
      font-weight: 400;
      line-height: 1.2;
      color: var(--accordion-heading-color, #1a1a1a);
    }

    .section-accordion__list {
      display: block;
    }

    .section-accordion__item {
      border-bottom: 1px solid var(--accordion-border-color, #e5e7eb);
    }

    .section-accordion__trigger {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 0;
      text-align: left;
      background: none;
      border: none;
      cursor: pointer;
      font-family: inherit;
      font-size: inherit;
      color: inherit;
    }

    .section-accordion__trigger:hover {
      opacity: 0.7;
    }

    .section-accordion__title {
      font-size: 1.125rem;
      font-weight: 500;
      padding-right: 1rem;
      color: var(--accordion-text-color, #1a1a1a);
    }

    .section-accordion__icon {
      flex-shrink: 0;
      transition: transform 0.3s ease;
      display: flex;
      align-items: center;
    }

    .section-accordion__trigger[aria-expanded="true"] .section-accordion__icon {
      transform: rotate(180deg);
    }

    .section-accordion__content {
      overflow: hidden;
    }

    .section-accordion__content[hidden] {
      display: none;
    }

    .section-accordion__inner {
      padding: 0 0 1rem 0;
    }

    .section-accordion__inner p {
      margin: 0 0 1rem 0;
    }

    .section-accordion__inner p:last-child {
      margin-bottom: 0;
    }

    .section-accordion__inner {
      color: var(--accordion-text-color, #1a1a1a);
    }
  </style>

  <script>
    (function() {
      var section = document.getElementById('{{ section_id }}');
      if (!section) return;

      var items = section.querySelectorAll('.section-accordion__item');
      var allowMultiple = section.getAttribute('data-allow-multiple') === 'true';

      items.forEach(function(item) {
        var trigger = item.querySelector('.section-accordion__trigger');
        var content = item.querySelector('.section-accordion__content');

        if (!trigger || !content) return;

        trigger.addEventListener('click', function() {
          var isOpen = trigger.getAttribute('aria-expanded') === 'true';

          if (!allowMultiple && !isOpen) {
            items.forEach(function(otherItem) {
              var otherTrigger = otherItem.querySelector('.section-accordion__trigger');
              var otherContent = otherItem.querySelector('.section-accordion__content');
              if (otherTrigger && otherContent) {
                otherTrigger.setAttribute('aria-expanded', 'false');
                otherContent.setAttribute('hidden', '');
              }
            });
          }

          if (isOpen) {
            trigger.setAttribute('aria-expanded', 'false');
            content.setAttribute('hidden', '');
          } else {
            trigger.setAttribute('aria-expanded', 'true');
            content.removeAttribute('hidden');
          }
        });
      });
    })();
  </script>
{%- endif -%}

{% schema %}
{
  "name": "Accordion",
  "tag": "section",
  "class": "accordion",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "header",
      "content": "Colors"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Text Color",
      "default": "#1a1a1a"
    },
    {
      "type": "color",
      "id": "border_color",
      "label": "Border Color",
      "default": "#e5e7eb"
    },
    {
      "type": "header",
      "content": "Settings"
    },
    {
      "type": "checkbox",
      "id": "allow_multiple",
      "label": "Allow multiple items open at once",
      "default": false
    },
    {
      "type": "text",
      "id": "custom_id",
      "label": "Custom Section ID"
    },
    {
      "type": "header",
      "content": "Spacing"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding Top",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 64,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding Bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 64,
      "unit": "px"
    }
  ],
  "blocks": [
    {
      "type": "item",
      "name": "Accordion Item",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Accordion Title"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content",
          "default": "<p>Add your content here.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Accordion",
      "blocks": [
        {
          "type": "item",
          "settings": {
            "title": "First Item",
            "content": "<p>Content for the first accordion item.</p>"
          }
        },
        {
          "type": "item",
          "settings": {
            "title": "Second Item",
            "content": "<p>Content for the second accordion item.</p>"
          }
        },
        {
          "type": "item",
          "settings": {
            "title": "Third Item",
            "content": "<p>Content for the third accordion item.</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}
