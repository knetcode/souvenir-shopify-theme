{%- liquid
  assign section_id = section.settings.custom_id | default: section.id
  assign section_class = 'section-accordion'
  assign allow_multiple = section.settings.allow_multiple
-%}

{%- if section.blocks.size > 0 -%}
  <section
    id="{{ section_id }}"
    class="{{ section_class }} py-12 px-6"
    data-allow-multiple="{{ allow_multiple }}"
    style="
      background-color: {{ section.settings.background_color | default: '#ffffff' }};
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    "
  >
    <div class="container">
      {%- if section.settings.heading != blank -%}
        <h2 class="text-3xl md:text-4xl mb-8 uppercase tracking-wide">
          {{ section.settings.heading }}
        </h2>
      {%- endif -%}

      <div class="accordion-list space-y-2">
        {%- for block in section.blocks -%}
          <div class="accordion-item border-b border-gray-200" {{ block.shopify_attributes }}>
            <button
              class="accordion-trigger w-full flex items-center justify-between py-4 text-left"
              aria-expanded="false"
              aria-controls="accordion-content-{{ block.id }}"
            >
              <span class="accordion-title text-lg font-medium pr-4">
                {{ block.settings.title }}
              </span>
              <span class="accordion-icon flex-shrink-0 transition-transform duration-300">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M6 9l6 6 6-6"/>
                </svg>
              </span>
            </button>
            <div
              id="accordion-content-{{ block.id }}"
              class="accordion-content overflow-hidden transition-all duration-300"
              style="max-height: 0;"
            >
              <div class="accordion-inner pb-4 pt-2">
                <div class="prose prose-lg max-w-none">
                  {{ block.settings.content }}
                </div>
              </div>
            </div>
          </div>
        {%- endfor -%}
      </div>
    </div>
  </section>
{%- endif -%}

{% stylesheet %}
  .{{ section_class }} .accordion-item {
    border-bottom: 1px solid #e5e7eb;
  }

  .{{ section_class }} .accordion-trigger {
    transition: opacity 0.2s ease;
  }

  .{{ section_class }} .accordion-trigger:hover {
    opacity: 0.7;
  }

  .{{ section_class }} .accordion-trigger[aria-expanded="true"] .accordion-icon {
    transform: rotate(180deg);
  }

  .{{ section_class }} .accordion-content {
    transition: max-height 0.3s ease, padding 0.3s ease;
  }

  .{{ section_class }} .space-y-2 > * + * {
    margin-top: 0.5rem;
  }
{% endstylesheet %}

{% javascript %}
  (function () {
    const accordions = document.querySelectorAll('.section-accordion .accordion-item');

    accordions.forEach((accordion) => {
      const trigger = accordion.querySelector('.accordion-trigger');
      const content = accordion.querySelector('.accordion-content');
      const inner = accordion.querySelector('.accordion-inner');

      if (!trigger || !content || !inner) return;

      trigger.addEventListener('click', () => {
        const isExpanded = trigger.getAttribute('aria-expanded') === 'true';
        const shouldExpand = !isExpanded;

        // Close all other accordions if only one should be open at a time
        const section = trigger.closest('.section-accordion');
        const allowMultiple = section?.dataset.allowMultiple === 'true';
        
        if (!allowMultiple && shouldExpand) {
          accordions.forEach((otherAccordion) => {
            if (otherAccordion !== accordion) {
              const otherTrigger = otherAccordion.querySelector('.accordion-trigger');
              const otherContent = otherAccordion.querySelector('.accordion-content');
              const otherInner = otherAccordion.querySelector('.accordion-inner');
              
              if (otherTrigger && otherContent && otherInner) {
                otherTrigger.setAttribute('aria-expanded', 'false');
                otherContent.style.maxHeight = '0px';
              }
            }
          });
        }

        // Toggle current accordion
        trigger.setAttribute('aria-expanded', shouldExpand);
        
        if (shouldExpand) {
          content.style.maxHeight = inner.scrollHeight + 'px';
        } else {
          content.style.maxHeight = '0px';
        }
      });
    });
  })();
{% endjavascript %}

{% schema %}
{
  "name": "Accordion",
  "tag": "section",
  "class": "accordion",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#ffffff"
    },
    {
      "type": "checkbox",
      "id": "allow_multiple",
      "label": "Allow multiple items open at once",
      "default": false
    },
    {
      "type": "text",
      "id": "custom_id",
      "label": "Custom Section ID"
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding Top",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 64,
      "unit": "px"
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding Bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "default": 64,
      "unit": "px"
    }
  ],
  "blocks": [
    {
      "type": "item",
      "name": "Accordion Item",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Accordion Title"
        },
        {
          "type": "richtext",
          "id": "content",
          "label": "Content",
          "default": "<p>Add your content here.</p>"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Accordion",
      "blocks": [
        {
          "type": "item",
          "settings": {
            "title": "First Item",
            "content": "<p>Content for the first accordion item.</p>"
          }
        },
        {
          "type": "item",
          "settings": {
            "title": "Second Item",
            "content": "<p>Content for the second accordion item.</p>"
          }
        },
        {
          "type": "item",
          "settings": {
            "title": "Third Item",
            "content": "<p>Content for the third accordion item.</p>"
          }
        }
      ]
    }
  ]
}
{% endschema %}
