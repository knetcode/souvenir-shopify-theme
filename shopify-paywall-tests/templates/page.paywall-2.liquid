{% comment %}
  Paywall-Protected Page Template 2
  This template requires purchase of paywall-product-2
{% endcomment %}

{% layout 'theme' %}

{% comment %}
  IMPORTANT: In Shopify, the customer object is only available on customer account pages
  (/account/*), not on regular page templates. This is a Shopify limitation.
  
  We need to check the customer object and their orders directly in the template.
{% endcomment %}
{% assign paywall_product_handle = 'paywall-product-2' %}
{% assign has_access = false %}
{% assign access_message = 'Purchase the Premium Content Pass to unlock this page.' %}
{% assign redirect_url = '/products/' | append: paywall_product_handle %}

{% comment %} Check if customer exists and has purchased the product {% endcomment %}
{% if customer %}
  {% comment %} Loop through customer orders to check for the paywall product {% endcomment %}
  {% for order in customer.orders %}
    {% if order.financial_status == 'paid' %}
      {% for line_item in order.line_items %}
        {% if line_item.product.handle == paywall_product_handle %}
          {% assign has_access = true %}
          {% break %}
        {% endif %}
      {% endfor %}
      {% if has_access %}{% break %}{% endif %}
    {% endif %}
  {% endfor %}
{% else %}
  {% assign access_message = 'Please log in to check your access.' %}
  {% assign redirect_url = '/account/login?return_url=' | append: request.path %}
{% endif %}

<style>
  .page-paywall__restricted .button:hover {
    background-color: #333 !important;
  }
  .page-paywall__restricted .button:active {
    background-color: #555 !important;
  }
</style>

<div class="page-width" style="padding: 4rem 0;">
  {% if has_access %}
    <div class="page-paywall__content">
      <h1>{{ page.title }}</h1>
      <div class="rte">
        {{ page.content }}
      </div>
    </div>
  {% else %}
    <div class="page-paywall__restricted" style="text-align: center; padding: 4rem 0;">
      {% if customer %}
        <h1>Unlock This Content</h1>
        <p style="font-size: 1.1rem; margin: 2rem 0;">{{ access_message }}</p>
        
        {% comment %} Debug output - remove after fixing {% endcomment %}
        <div style="background: #f5f5f5; padding: 1rem; margin: 1rem 0; border-radius: 4px; font-size: 0.9rem; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
          <strong>Debug Info:</strong><br>
          Customer object exists: {% if customer %}YES (ID: {{ customer.id }}){% else %}NO{% endif %}<br>
          Looking for product: {{ paywall_product_handle }}<br>
          Customer orders count: {{ customer.orders.size }}<br>
          Has access: {{ has_access }}<br>
          {% if customer.orders.size > 0 %}
            Orders checked:
            <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
              {% for order in customer.orders limit: 5 %}
                <li>Order #{{ order.order_number }} - Status: {{ order.financial_status }}
                  {% if order.financial_status == 'paid' %}
                    - Items:
                    {% for line_item in order.line_items limit: 3 %}
                      {{ line_item.product.handle }}{% unless forloop.last %}, {% endunless %}
                    {% endfor %}
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            No orders found
          {% endif %}
        </div>
        
        {% if redirect_url != blank %}
          <a href="{{ redirect_url }}" class="button" style="display: inline-block; padding: 0.75rem 2rem; background-color: #000; color: #fff; text-decoration: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;">Purchase Access</a>
        {% else %}
          <a href="/products/{{ paywall_product_handle }}" class="button" style="display: inline-block; padding: 0.75rem 2rem; background-color: #000; color: #fff; text-decoration: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;">Purchase Access</a>
        {% endif %}
      {% else %}
        <h1>Login Required</h1>
        <p style="font-size: 1.1rem; margin: 2rem 0;">{{ access_message }}</p>
        
        {% comment %} Debug output {% endcomment %}
        <div style="background: #f5f5f5; padding: 1rem; margin: 1rem 0; border-radius: 4px; font-size: 0.9rem; text-align: left; max-width: 600px; margin-left: auto; margin-right: auto;">
          <strong>Debug Info:</strong><br>
          Customer object exists: NO<br>
          You need to be logged in to check purchase status.
        </div>
        
        {% if redirect_url != blank %}
          <a href="{{ redirect_url }}" class="button" style="display: inline-block; padding: 0.75rem 2rem; background-color: #000; color: #fff; text-decoration: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;">Log In</a>
        {% else %}
          <a href="/account/login" class="button" style="display: inline-block; padding: 0.75rem 2rem; background-color: #000; color: #fff; text-decoration: none; border-radius: 4px; cursor: pointer; transition: background-color 0.2s;">Log In</a>
        {% endif %}
      {% endif %}
    </div>
  {% endif %}
</div>

